name: Release gem
run-name: Release ${{ github.event.inputs.repo }} ${{ github.event.inputs.tag }}

on:
  workflow_dispatch:
    inputs:
      repo:
        description: "Repository to release (e.g., owner/repo)"
        required: true
        type: string
      tag:
        description: "Tag to release (e.g., v1.0.0)"
        required: true
        type: string
      announce:
        description: "Trigger release announcements"
        required: false
        type: boolean
        default: true

jobs:
  release:
    permissions:
      id-token: write # For OIDC authentication
      contents: write
      actions: write # For triggering announce workflow

    runs-on: ubuntu-latest
    steps:
      - name: Checkout release-machine
        uses: actions/checkout@v6
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}
          path: release-machine

      - name: Checkout repo to release
        uses: actions/checkout@v6
        with:
          repository: ${{github.event.inputs.repo}}
          ref: refs/tags/${{github.event.inputs.tag}}
          path: release-gem

      - name: Extract gem name
        id: gem_name
        run: |
          # Find the .gemspec file
          GEMSPEC=$(find release-gem -maxdepth 1 -name "*.gemspec" -type f | head -1)

          if [ -z "$GEMSPEC" ]; then
            echo "ERROR: No .gemspec file found in repository"
            exit 1
          fi

          # Extract gem name from gemspec filename ("hanami-router.gemspec" -> "hanami-router")
          GEM_NAME=$(basename "$GEMSPEC" .gemspec)

          if [ -z "$GEM_NAME" ]; then
            echo "ERROR: Could not extract gem name from $GEMSPEC"
            exit 1
          fi

          echo "gem_name=$GEM_NAME" >> $GITHUB_OUTPUT

      - name: Prepare authorized releaser keys
        env:
          GEM_NAME: ${{ steps.gem_name.outputs.gem_name }}
        run: |
          set -e

          RELEASERS_YML="release-machine/releasers.yml"
          RELEASER_KEYS_DIR="release-machine/releasers"

          # Get releasers for gem (default releasers + gem-specific releasers)
          RELEASERS=$(
            {
              yq eval '.default[]' "$RELEASERS_YML" 2>/dev/null
              yq eval ".gems.\"$GEM_NAME\"[]" "$RELEASERS_YML" 2>/dev/null
            } | sort -u
          )

          if [ -z "$RELEASERS" ]; then
            echo "ERROR: No releasers configured for '$GEM_NAME'"
            exit 1
          fi

          # Build GPG keyring for releasers
          while read -r username; do
            GPG_FILE="$RELEASER_KEYS_DIR/${username}.gpg.asc"
            if [ -f "$GPG_FILE" ] && grep -q "^-----BEGIN" "$GPG_FILE"; then
              gpg --import "$GPG_FILE" 2>/dev/null || true
            fi
          done <<< "$RELEASERS"

          # Build SSH allowed signers for releaser keys
          mkdir -p ~/.ssh
          touch ~/.ssh/allowed_signers

          while read -r username; do
            SSH_FILE="$RELEASER_KEYS_DIR/${username}.ssh.txt"
            if [ -f "$SSH_FILE" ]; then
              grep -v '^#' "$SSH_FILE" | grep -v '^$' >> ~/.ssh/allowed_signers || true
            fi
          done <<< "$RELEASERS"

          chmod 600 ~/.ssh/allowed_signers
          git config --global gpg.ssh.allowedSignersFile ~/.ssh/allowed_signers

      - name: Verify release tag
        id: verify_tag
        working-directory: release-gem
        run: |
          # Fails if the tag is not signed by one of our authorized keys
          git tag -v "${{ github.event.inputs.tag }}"

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.4

      - uses: rubygems/configure-rubygems-credentials@v1.0.0

      - name: Publish gem
        working-directory: release-gem
        env:
          GEM_NAME: ${{ steps.gem_name.outputs.gem_name }}
        run: |
          gem build "${GEM_NAME}.gemspec"
          gem push "${GEM_NAME}"-*.gem

      - name: Wait for release
        working-directory: release-gem
        env:
          GEM_NAME: ${{ steps.gem_name.outputs.gem_name }}
        run: |
          gem install rubygems-await
          gem await "${GEM_NAME}"-*.gem

      - name: Create GitHub release
        working-directory: release-gem
        env:
          GITHUB_TOKEN: ${{ secrets.CREATE_GITHUB_RELEASE_TOKEN }}
        run: |
          ruby ../release-machine/.github/scripts/create-github-release.rb \
            "${{ github.event.inputs.repo }}" \
            "${{ github.event.inputs.tag }}"

      - name: Annotate workflow
        id: annotate
        working-directory: release-gem
        run: |
          TAG="${{ github.event.inputs.tag }}"
          TAGGER=$(git for-each-ref --format='%(taggername)' "refs/tags/$TAG")
          if [ -z "$TAGGER" ]; then
            TAGGER=$(git log -1 --pretty=format:'%an' "$TAG")
          fi
          echo "### Tag created by: $TAGGER" >> $GITHUB_STEP_SUMMARY
          echo "tagger=$TAGGER" >> $GITHUB_OUTPUT

      - name: Update release history
        working-directory: release-machine
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # Extract tagger email from the release tag
          pushd ../release-gem > /dev/null
          TAGGER_EMAIL=$(git for-each-ref --format='%(taggeremail)' "refs/tags/${{ github.event.inputs.tag }}" | tr -d '<>')
          if [ -z "$TAGGER_EMAIL" ]; then
            TAGGER_EMAIL=$(git log -1 --pretty=format:'%ae' "${{ github.event.inputs.tag }}")
          fi
          popd > /dev/null

          # Add release entry
          ./.github/scripts/add-release.sh \
            "${{ steps.gem_name.outputs.gem_name }}" \
            "${{ github.event.inputs.tag }}" \
            "$TAGGER_EMAIL"

          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add RELEASES.md
          git commit -m "Add release: ${{ steps.gem_name.outputs.gem_name }} ${{ github.event.inputs.tag }}"
          git push

      - name: Trigger announcements
        if: github.event.inputs.announce == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "announce.yml",
              ref: "main",
              inputs: {
                repo: "${{ github.event.inputs.repo }}",
                tag: "${{ github.event.inputs.tag }}",
                gem_name: "${{ steps.gem_name.outputs.gem_name }}"
              }
            });
